<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SBED Lab Research Assistant (Demo)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:24px; max-width:900px}
    .box{border:1px solid #ddd; border-radius:12px; padding:16px; margin-top:12px}
    input{width:100%; padding:12px; border-radius:10px; border:1px solid #ccc; font-size:16px}
    button{padding:10px 14px; border-radius:10px; border:0; cursor:pointer; margin-top:10px}
    .row{display:flex; gap:10px; align-items:center}
    .row button{white-space:nowrap}
    ul{margin:8px 0 0 18px}
    .muted{color:#666; font-size:14px}
    .card{padding:10px 12px; border:1px solid #eee; border-radius:10px; margin-top:8px}
    a{word-break:break-word}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h1>SBED Lab Research Assistant (Demo)</h1>
  <p class="muted">Step 1: This is a fake/demo version. Next we connect real AI.</p>

  <div class="box">
    <label><b>Research topic</b></label>
    <input id="topic" placeholder="Example: AI for HVAC fault detection using BAS data" />
    <div class="row">
      <button id="runBtn">Run (Demo)</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="box">
    <h2>Results</h2>

    <h3>Keywords</h3>
    <ul id="keywords"></ul>

    <h3>Papers</h3>
    <div id="papers"></div>

    <h3>Datasets</h3>
    <div id="datasets"></div>

    <h3>Research gaps</h3>
    <ul id="gaps"></ul>
  </div>

<script>
  const WORKER_URL = "https://orange-darkness-b69a.nuha-juneidi.workers.dev/";

  function clearUI(){
    document.getElementById("keywords").innerHTML = "";
    document.getElementById("papers").innerHTML = "";
    document.getElementById("datasets").innerHTML = "";
    document.getElementById("gaps").innerHTML = "";
  }

  async function runSearch() {
    const topic = document.getElementById("topic").value.trim() || "PCM HVAC thermal energy storage";
    document.getElementById("status").textContent = "Searching real papers...";
    clearUI();

    let json;
    try {
      const response = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ topic })
      });

      if (!response.ok) {
        const txt = await response.text();
        document.getElementById("status").textContent = "Backend error";
        document.getElementById("keywords").innerHTML = `<li>${txt}</li>`;
        return;
      }

      json = await response.json();
    } catch (e) {
      document.getElementById("status").textContent = "Network error";
      document.getElementById("keywords").innerHTML = `<li>${String(e)}</li>`;
      return;
    }

    const papers = Array.isArray(json.papers) ? json.papers : [];

    // Show papers on the page
    const papersDiv = document.getElementById("papers");
    papersDiv.innerHTML = "";

    if (papers.length === 0) {
      document.getElementById("status").textContent = "No papers returned (Worker still echo/demo?)";
      document.getElementById("keywords").innerHTML = `<li>Backend returned no papers.</li>`;
      return;
    }

    papers.forEach((p, i) => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <b>${i + 1}) ${p.title || ""}</b><br>
        <span class="muted">${p.authors || ""}</span><br>
        <span class="muted">${p.year || ""} — ${p.venue || ""}</span><br>
        <a href="${p.doiOrUrl || "#"}" target="_blank" rel="noopener">Open</a>
      `;
      papersDiv.appendChild(div);
    });

    // Build Excel
    const header = [
      "Title", "Authors", "Year", "Journal/Conference",
      "Methodology", "HVAC application", "PCM type",
      "Key findings", "Research gaps", "DOI/URL"
    ];

    const rows = [header];

    papers.forEach(p => {
      rows.push([
        p.title || "",
        p.authors || "",
        p.year || "",
        p.venue || "",
        p.methodology || "",
        p.hvacApplication || "",
        p.pcmType || "",
        p.keyFindings || "",
        p.researchGaps || "",
        p.doiOrUrl || ""
      ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Top 5 Papers");

    const safeTopic = (json.topic || topic).toString().replace(/[^\w\-]+/g, "_").slice(0, 50);
    XLSX.writeFile(wb, `Literature_Summary_${safeTopic}.xlsx`);

    document.getElementById("status").textContent = "Done ✔ Excel downloaded.";
  }

  // One click handler only
  document.getElementById("runBtn").onclick = runSearch;
</script>

</body>
</html>
